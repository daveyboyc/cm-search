
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The easiest way to explore Capacity Market auctions ‚Äî no fuss, just results.">
    <title>Capacity Market Search</title>
    
    <!-- Piwik Pro Tag Manager -->
    <script type="text/javascript">
    (function(window, document, dataLayerName, id) {
    window[dataLayerName]=window[dataLayerName]||[],window[dataLayerName].push({start:(new Date).getTime(),event:"stg.start"});var scripts=document.getElementsByTagName('script')[0],tags=document.createElement('script');
    var qP=[];dataLayerName!=="dataLayer"&&qP.push("data_layer_name="+dataLayerName);var qPString=qP.length>0?("?"+qP.join("&")):"";
    tags.async=!0,tags.src="https://capacitymarket.containers.piwik.pro/"+id+".js"+qPString,scripts.parentNode.insertBefore(tags,scripts);
    !function(a,n,i){a[n]=a[n]||{};for(var c=0;c<i.length;c++)!function(i){a[n][i]=a[n][i]||{},a[n][i].api=a[n][i].api||function(){var a=[].slice.call(arguments,0);"string"==typeof a[0]&&window[dataLayerName].push({event:n+"."+i+":"+a[0],parameters:[].slice.call(arguments,1)})}}(i[c])}(window,"ppms",["tm","cm"]);
    })(window, document, 'dataLayer', 'f2a3c780-6df8-47be-be72-812064ff34a8');
    </script>
    <!-- End Piwik Pro Tag Manager -->
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    <style>
        /* Define background image variables based on theme */
        html[data-bs-theme="light"] {
            --bg-image: url("/static/images/backgrounds/industrial_background.jpeg");
        }
        html[data-bs-theme="dark"] {
            --bg-image: url("/static/images/backgrounds/industrial_background_dark.jpeg"); /* Reverted to .jpeg to match renamed file */
        }

        /* Apply background and flex styles to body */
        body, html {
            height: 100%; /* Needed for full height background */
            margin: 0; /* Remove default body margin */
            /* Background image set using CSS variable */
            background-image: var(--bg-image);
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            font-family: 'Roboto', sans-serif; /* Use Roboto font */
        }

        /* Adjust container for background */
        .container {
            max-width: 1100px; /* Match search page */
            margin: 20px auto; /* Center with margin */
            background-color: rgba(var(--bs-body-bg-rgb), 0.92); /* Slightly less transparent */
            padding: 30px;
            border-radius: 8px;
            flex-grow: 1; /* Allow content to grow */
            width: 95%;
            color: var(--bs-body-color); /* Use Bootstrap variable for text */
        }

        /* Keep other base styles */
        .error { color: var(--bs-danger); } /* Use BS variable */
        nav ul { list-style: none; padding: 0; }
        nav ul li { display: inline; margin-right: 10px; }
        .card {
             /* Use Bootstrap variables */
             background-color: var(--bs-card-bg);
             border: var(--bs-border-width) solid var(--bs-border-color);
             padding: 15px;
             margin-bottom: 15px;
             border-radius: var(--bs-card-border-radius);
        }
        .card-header { font-weight: bold; margin-bottom: 10px; }

        /* Footer Styles */
        .page-footer {
            position: fixed; /* Fix position relative to viewport */
            bottom: 10px;    /* Position 10px from the bottom */
            right: 10px;     /* Position 10px from the right */
            background-color: rgba(var(--bs-tertiary-bg-rgb), 0.8); /* Semi-transparent tertiary bg */
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000; /* Ensure it's above other content */
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Vertically center items */
        }
        .page-footer ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex; /* Use flexbox for horizontal list */
            align-items: center;
        }
        .page-footer ul li {
            margin-left: 10px; /* Space between items */
        }
        .page-footer ul li:first-child {
            margin-left: 0;
        }

        /* Theme Switch Styling */
        .theme-switch-wrapper {
          display: flex;
          align-items: center;
          margin-left: 15px; /* Space between links and toggle */
        }

        .theme-switch {
          position: relative;
          display: inline-block;
          width: 50px; /* Slightly smaller */
          height: 28px; /* Slightly smaller */
        }

        .theme-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 20px; /* Adjusted */
          width: 20px;  /* Adjusted */
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
        }

        input:checked + .slider {
          background-color: #0d6efd; /* Bootstrap primary */
        }

        input:focus + .slider {
          box-shadow: 0 0 1px #0d6efd;
        }

        input:checked + .slider:before {
          transform: translateX(22px); /* Adjusted */
        }

        /* Rounded sliders */
        .slider.round {
          border-radius: 28px; /* Adjusted */
        }

        .slider.round:before {
          border-radius: 50%;
        }
        .theme-label {
            margin-left: 8px;
            font-size: 0.9em;
            color: var(--bs-body-color); /* Use Bootstrap text color */
        }

        /* Style for top navigation links */
        .top-nav-link {
            color: white !important; /* Use !important to override potential Bootstrap specificity */
            text-decoration: none; /* Optional: remove underline */
        }
        .top-nav-link:hover {
            color: #cccccc !important; /* Lighter gray on hover */
        }
        
        /* Help Button Styles */
        #helpButton {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        #helpButton:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        
        /* Help Modal Styles */
        #helpModal .list-group-item.active {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }
        
        .help-section {
            margin-bottom: 2rem;
            padding-top: 1.5rem;
            border-bottom: 1px solid var(--bs-border-color);
            padding-bottom: 1.5rem;
        }
        
        .help-section:last-child {
            border-bottom: none;
        }
        
        .help-section h4 {
            color: var(--bs-primary);
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        /* Tab content scrollable container */
        #helpTabContent {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
            position: relative;
        }
        
        /* Section highlight effect */
        @keyframes section-highlight {
            0% { background-color: transparent; }
            30% { background-color: rgba(var(--bs-primary-rgb), 0.15); }
            100% { background-color: transparent; }
        }
        
        .highlight-section {
            animation: section-highlight 1s ease-in-out;
            border-radius: 0.25rem;
            padding: 0.25rem;
        }

        /* Mobile hamburger menu - simple white lines */
        .mobile-hamburger-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            cursor: pointer;
            gap: 4px;
        }
        
        /* Hide hamburger menu on map pages */
        body.map-page .mobile-hamburger-btn,
        body.map-page .mobile-nav-overlay,
        body.map-page .mobile-nav-panel {
            display: none !important;
        }
        
        /* Hide top navigation on map pages */
        body.map-page .top-nav-container {
            display: none !important;
        }
        
        .mobile-hamburger-btn span {
            display: block;
            width: 25px;
            height: 3px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .mobile-hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }
        
        .mobile-hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }
        
        .mobile-hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }
        
        /* Mobile menu overlay */
        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1040;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .mobile-nav-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Mobile menu panel */
        .mobile-nav-panel {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: white;
            z-index: 1041;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
        }
        
        .mobile-nav-panel.active {
            left: 0;
        }
        
        .mobile-nav-header {
            padding: 20px;
            background: #4285f4;
            color: white;
        }
        
        .mobile-nav-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .mobile-nav-content {
            padding: 20px;
        }
        
        .mobile-nav-item {
            display: block;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            font-size: 1.1rem;
        }
        
        .mobile-nav-item:hover {
            color: #4285f4;
            text-decoration: none;
        }
        
        .mobile-nav-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            /* Show hamburger menu on mobile */
            .mobile-hamburger-btn {
                display: flex !important;
            }
            
            /* Hide top navigation on mobile - more specific selector */
            .top-nav-container {
                display: none !important;
            }
            
            /* Show theme button on mobile - positioned in top right */
            .theme-button-container {
                display: block !important;
                top: 15px !important;
                right: 15px !important;
            }
            
            /* Adjust container for mobile */
            .container {
                margin: 10px auto;
                padding: 15px;
                width: 98%;
                border-radius: 6px;
            }
            
            /* Mobile theme button */
            #themeCycleButton {
                top: 5px !important;
                right: 5px !important;
                padding: 6px 8px !important;
                font-size: 0.8rem !important;
            }
            
            #themeCycleButton #theme-text {
                display: none; /* Hide text on mobile */
            }
            
            /* Mobile help button */
            #helpButton {
                width: 44px !important;
                height: 44px !important;
                font-size: 1.2rem !important;
                bottom: 15px !important;
                right: 15px !important;
            }
            
            /* Mobile modal adjustments */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-body .container-fluid {
                padding: 0;
            }
            
            .modal-body .row {
                flex-direction: column;
            }
            
            .modal-body .col-md-3,
            .modal-body .col-md-9 {
                max-width: 100%;
                flex: none;
            }
            
            .list-group {
                margin-bottom: 15px;
            }
            
            #helpContent {
                max-height: 400px;
            }
            
            /* Make form elements touch-friendly */
            input, select, textarea, button {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            /* Card adjustments for mobile */
            .card {
                margin-bottom: 10px;
                padding: 12px;
            }
            
            /* Table responsive improvements */
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .table th,
            .table td {
                padding: 8px 6px;
                white-space: nowrap;
            }
            
            /* Badge adjustments for mobile */
            .badge {
                font-size: 0.7rem;
                padding: 3px 6px;
                margin: 1px;
            }
        }
        
        /* Small mobile phones */
        @media (max-width: 480px) {
            body > div:first-child {
                padding: 3px 8px !important;
            }
            
            body > div:first-child ul {
                gap: 8px !important;
                font-size: 0.85rem;
            }
            
            .container {
                margin: 5px auto;
                padding: 10px;
                width: 99%;
            }
            
            .modal-dialog {
                margin: 5px;
                max-width: calc(100% - 10px);
            }
            
            #helpContent {
                max-height: 350px;
            }
            
            .table {
                font-size: 0.8rem;
            }
            
            .table th,
            .table td {
                padding: 6px 4px;
            }
            
            .badge {
                font-size: 0.65rem;
                padding: 2px 4px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }
        
        /* Touch-friendly interactions */
        @media (hover: none) and (pointer: coarse) {
            .btn,
            .badge,
            .top-nav-link,
            .list-group-item-action {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            
            .table-responsive {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Landscape mobile adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            #helpContent {
                max-height: 300px;
            }
            
            .modal-dialog {
                margin: 5px;
            }
        }
    </style>
    
    <!-- Favicon - Keep specific ones if needed, base.html has basic one -->
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/static/images/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/static/images/favicon.png">
    <!-- Stylesheets - Keep specific ones if needed, base.html has Bootstrap -->
     
     
     
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Keep body/html styles specific to this page structure? 
           Or rely on base.html and adjust container? 
           For now, keep but remove background-image handled by base 
        */
        body, html {
            /* height: 100%; */ /* Handled by base */
            /* margin: 0; */ /* Handled by base */
            /* background-image: url("/static/images/backgrounds/industrial_background.jpeg"); */ /* Handled by base */
            /* background-position: center; */ /* Handled by base */
            /* background-repeat: no-repeat; */ /* Handled by base */
            /* background-size: cover; */ /* Handled by base */
            /* background-attachment: fixed; */ /* Handled by base */
            /* display: flex; */ /* Handled by base */
            /* flex-direction: column; */ /* Handled by base */
            /* font-family: 'Roboto', sans-serif; */ /* Handled by base */
        }
        .google-like-header {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center items horizontally */
            justify-content: center; /* Center items vertically */
            text-align: center;
            padding-top: 5vh; /* Reduced from 15vh to bring content higher */ /* Adjust padding to position vertically */
            padding-bottom: 5vh;
            flex-shrink: 0;
            position: relative; /* Needed for absolute positioning of child */
            /* Need to adjust title color for theme - now outside container */
            /* color: var(--bs-body-color); */ /* REMOVE */
            color: white; /* Keep header text white for visibility on image */
        }
        .google-like-header h1 {
            /* color: white; */ /* REMOVE - handled by parent or use BS var? */
            font-weight: bold;
            font-size: 4.5rem; /* Larger font size */
            margin-bottom: 2rem; /* Space below title */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); /* Slightly stronger shadow - may need theme adjustment */
        }
        .google-like-header .search-form {
            max-width: 600px; /* Wider search bar */
            width: 100%;
            margin: 0 auto; /* Center the form */
        }
        .google-like-header .search-form .form-control {
            height: 45px; /* Taller search input */
            border-radius: 25px; /* Rounded corners */
            padding-left: 20px;
            padding-right: 20px;
            /* Use BS vars for theme compatibility */
            border: var(--bs-border-width) solid var(--bs-border-color);
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            box-shadow: 0 1px 6px rgba(32,33,36,0.1);
            font-size: 14px; /* Slightly smaller font size to fit longer placeholder */
        }
        .google-like-header .search-form .btn {
            border-radius: 25px; /* Match input rounding */
            height: 45px;
        }
        .content-below-header {
            /* Use BS vars, base container handles most */
            /* background-color: rgba(255, 255, 255, 0.95); */ /* REMOVE */
            /* padding: 30px; */ /* From base */
            /* border-radius: 8px; */ /* From base */
            /* margin: 20px auto; */ /* From base */
            /* max-width: 1100px; */ /* From base */
            /* width: 95%; */ /* From base */
            /* flex-grow: 1; */ /* From base */
            min-height: auto; /* Let content determine minimum height */
            display: flex; /* Use flexbox internally too */
            flex-direction: column; /* Stack children vertically */
        }

        /* Keep existing styles for results, etc. */
        .results-list .result-item {
             /* Use BS vars */
            border-bottom: var(--bs-border-width) solid var(--bs-border-color-translucent);
            padding: 15px 0;
        }
        .results-list .result-item:last-child {
            border-bottom: none;
        }
        .company-links-section h3,
        .component-results-section h3 {
             margin-bottom: 15px;
             /* Use BS theme colors */
             border-bottom: 2px solid var(--bs-primary);
             padding-bottom: 5px;
             display: inline-block;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .section-header h3 {
            margin-bottom: 0;
             /* Use BS theme colors */
            border-bottom: 2px solid var(--bs-primary);
            padding-bottom: 5px;
        }
        .sort-toggle {
            text-decoration: none;
            /* Use BS var */
            color: var(--bs-secondary-color);
        }
        .sort-toggle span {
            font-weight: bold;
            font-size: 1.2em;
        }
        .pagination-nav {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        /* Enhanced pagination styling */
        .pagination-lg .page-link {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
            font-weight: bold;
        }
        .component-record {
            margin-bottom: 1.5rem;
        }
        .component-record strong a {
            font-size: 1.1em;
            /* Link color handled by Bootstrap */
        }
        .cmu-badge {
             font-size: 0.9em;
             /* Badge styling handled by Bootstrap */
        }
        /* Sort controls styling */
        .sort-controls {
            margin-bottom: 15px;
            padding: 10px;
             /* Use BS vars */
            background-color: var(--bs-tertiary-bg);
            border-radius: var(--bs-border-radius);
            font-size: 0.9rem;
        }
        .sort-controls a {
            margin-right: 10px;
            text-decoration: none;
             /* Use BS vars */
            color: var(--bs-link-color);
        }
        .sort-controls .active-sort {
            font-weight: bold;
             /* Use BS vars */
            color: var(--bs-body-color);
        }
        .sort-controls .sort-icon {
             margin-left: 3px;
        }
        /* Adjust link colors in header for visibility on dark background */
        .google-like-header .stats-link-container a.btn-light {
            color: var(--bs-dark); /* Dark text on light button */
            border-color: var(--bs-dark);
        }
         .google-like-header .stats-link-container a.btn-light:hover {
             background-color: var(--bs-gray-200);
         }
        .google-like-header .stats-link-container a.btn-info {
            /* Info buttons usually okay on dark/light */
        }
         .google-like-header .stats-link-container a.btn-warning {
             color: var(--bs-dark); /* Dark text on warning button */
         }

        /* Style for the container on initial load to hide its appearance */
        .container-initial-search {
            padding: 0 !important; 
            margin: 0 !important;
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            /* flex-grow: 0 !important; */ /* Let base handle flex */
        }

        /* Style for the container when there are no results */
        .container-no-results {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Custom style for the no-results alert to make it narrower */
        .alert-no-results {
            display: inline-block !important;
            margin: 0 auto !important;
            max-width: fit-content !important;
            padding-left: 2rem !important;
            padding-right: 2rem !important;
        }

        /* Make company links lighter in dark mode */
        html[data-bs-theme="dark"] .company-link-item a {
            color: var(--bs-link-color); /* Use standard BS link color for dark mode */
        }
        html[data-bs-theme="dark"] .company-link-item a:hover {
            color: var(--bs-link-hover-color); /* Use standard BS link hover color */
        }

        /* Styles for Popover Info Links in Header */
        .google-like-header .popover-info-link {
            color: white;
            font-weight: 600; /* Bolder text */
            text-decoration: none;
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem; /* Retain for potential subtle hover background if desired later */
            transition: color 0.15s ease-in-out, text-decoration 0.15s ease-in-out;
            display: inline-block; 
            /* Removed border and background-color from default state */
        }

        .google-like-header .popover-info-link:hover,
        .google-like-header .popover-info-link:focus {
            color: white; /* Keep text white */
            text-decoration: underline; /* Add underline on hover/focus for interactivity */
            background-color: transparent; /* Ensure no background on hover/focus */
            outline: none;
            box-shadow: none;
        }

        
        /* Style for map view buttons to add extra spacing */
        .map-view-btn {
            margin-right: 20px !important;
            margin-left: 25px !important;
            padding-left: 15px !important;
            padding-right: 15px !important;
        }
        
        /* Hide "Capacity Market Search" text on mobile */
        @media (max-width: 768px) {
            .google-like-header h1 {
                display: none;
            }
            
            
            /* Make search bar narrower on mobile */
            .google-like-header .search-form {
                margin: 0 20px !important;
                max-width: calc(100% - 40px) !important;
                width: calc(100% - 40px) !important;
            }
            
            /* Ensure proper rounded corners on mobile */
            .google-like-header .search-form .input-group {
                border-radius: 25px !important;
                overflow: hidden;
            }
            
            .google-like-header .search-form .form-control {
                border-radius: 25px 0 0 25px !important;
                border: 1px solid #ddd !important;
                font-size: 12px !important;
            }
            
            .google-like-header .search-form .btn {
                border-radius: 0 25px 25px 0 !important;
            }
            
            /* Move search area down on initial page (no search results) */
            .google-like-header {
                padding-top: 15vh !important;
            }
            
            /* Hide text labels on buttons, keep only icons */
            .stats-link-container .btn {
                font-size: 0 !important;
                width: 50px !important;
                height: 50px !important;
                border-radius: 12px !important;
                padding: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            /* Show only the icons with proper size */
            .stats-link-container .btn i,
            .stats-link-container .btn .fa,
            .stats-link-container .btn .fas,
            .stats-link-container .btn .bi {
                font-size: 20px !important;
                display: block !important;
            }
            
            /* Center the coffee button below the other two */
            .stats-link-container {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                gap: 10px !important;
            }
            
            .stats-link-container .mb-2 {
                display: flex !important;
                justify-content: center !important;
                gap: 15px !important;
                margin-bottom: 10px !important;
            }
        }
        
        /* Make Map View button green for both mobile and desktop */
        .stats-link-container .btn-info,
        .stats-link-container a[href*="map"] {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
        }
        
        .stats-link-container .btn-info:hover,
        .stats-link-container a[href*="map"]:hover {
            background-color: #218838 !important;
            border-color: #1e7e34 !important;
            color: white !important;
        }
    </style>
    <!-- Matomo already in base -->

</head>
<body class="">
    <!-- Mobile Hamburger Menu (only shows on mobile, not on map pages) -->
    <button class="mobile-hamburger-btn" id="mobileHamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
    
    <!-- Mobile Navigation Panel -->
    <div class="mobile-nav-panel" id="mobileNavPanel">
        <div class="mobile-nav-content" style="padding-top: 40px;">
            <a href="/" class="mobile-nav-item">
                <i class="bi bi-search"></i>Search
            </a>
            <a href="/map_results/technology/" class="mobile-nav-item">
                <i class="bi bi-geo-alt"></i>Map View
            </a>
            <a href="/statistics/" class="mobile-nav-item">
                <i class="bi bi-bar-chart"></i>Statistics
            </a>
            <a href="/donation/" class="mobile-nav-item">
                <i class="bi bi-heart"></i>Support Us
            </a>
            <a href="/help/" class="mobile-nav-item">
                <i class="bi bi-question-circle"></i>Help
            </a>
            
                <a href="/accounts/login/" class="mobile-nav-item">
                    <i class="bi bi-box-arrow-in-right"></i>Login
                </a>
                <a href="/account/register/" class="mobile-nav-item">
                    <i class="bi bi-person-plus"></i>Register
                </a>
            
        </div>
    </div>

    <!-- Top Navigation Links (Moved to top, scrolls with page) -->
    <div class="top-nav-container" style="display: flex; justify-content: flex-end; padding: 10px 100px 10px 15px; /* Push links right, add right padding for theme button */">
        <ul style="list-style: none; padding: 0; margin: 0; display: flex; align-items: center; gap: 15px;">
            <li><a href="/" class="top-nav-link">Search</a></li>
            <li><a href="/map_results/technology/" class="top-nav-link">Map</a></li>
            <li><a href="/statistics/" class="top-nav-link">Stats</a></li>
            
                <li><a href="/accounts/login/" class="top-nav-link">Login</a></li>
                <li><a href="/account/register/" class="top-nav-link">Register</a></li>
            
        </ul>
    </div>

    
    
<!-- Google-like Header -->
<div class="google-like-header">
    <img src="/static/images/favicon.png" alt="Capacity Market Logo" style="width: 100px; height: auto; margin-bottom: 1rem; filter: drop-shadow(0 0 3px white) drop-shadow(0 0 5px white) drop-shadow(0 0 7px white) drop-shadow(0 0 9px white);">
    <h1>Capacity Market Search</h1>
    <form method="get" action="/" class="search-form"> 
        <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Search company name, component, post code or CMU ID" value="test123">
            
            <input type="hidden" name="per_page" value="10">
            <input type="hidden" name="sort_by" value="relevance">
            <input type="hidden" name="sort_order" value="desc">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>
    <!-- Rearrange links below search bar -->
    <div class="stats-link-container mt-3 text-center"> 
            <!-- Row 1: Stats and Map -->
        <div class="mb-2 d-flex justify-content-center gap-2"> 
            <a href="/statistics/" class="btn btn-light"> 
                <i class="bi bi-bar-chart-line-fill"></i> Statistics
            </a>
            <a href="/map_results/technology/" class="btn btn-info"> 
                <i class="bi bi-map-fill"></i> Map View
            </a>
        </div>
        <!-- Row 2: Buy Me a Coffee -->
        <div> 
            <a href="/donate/" class="btn btn-warning"> 
                <i class="bi bi-cup-hot-fill"></i> Buy Me a Coffee
            </a>
        </div>
    </div>

    <!-- Explanatory Bubbles -->
    <div class="explanatory-bubbles-container mt-4 d-flex justify-content-center gap-3">
        <a tabindex="0" class="popover-info-link" role="button" data-bs-toggle="popover" data-bs-trigger="focus" 
           data-bs-placement="bottom" data-bs-html="true" title="‚ö° What Is the Capacity Market?"
           data-bs-content="<p class='mb-2'>The UK's Capacity Market is a government-backed scheme that ensures the stability of electricity supply. It does this by paying energy providers‚Äîlike power stations, battery storage sites, and demand-side response operators‚Äîto guarantee their availability during times of peak demand. Think of it as an insurance policy to prevent blackouts and support grid reliability, especially during extreme weather or when renewables underperform.</p><p>The Capacity Market plays a crucial role in encouraging investment in flexible and reliable energy assets, helping the UK transition to a low-carbon and resilient power system.</p>">
            ‚ö° What Is the Capacity Market?
        </a>
        <a tabindex="0" class="popover-info-link" role="button" data-bs-toggle="popover" data-bs-trigger="focus" 
           data-bs-placement="bottom" data-bs-html="true" title="üîç How to Use This Site"
           data-bs-content="<p class='mb-2'>CapacityMarket.co.uk helps you explore and understand the assets that participate in the Capacity Market. You can:</p><ul class='list-unstyled ps-3 mb-0'><li><i class='bi bi-search me-2'></i><strong>Search</strong> for specific components (like generators, batteries, or DSR units) by name, location, or CMU ID.</li><li><i class='bi bi-diagram-3 me-2'></i><strong>Group &amp; compare</strong> assets by location or delivery year.</li><li><i class='bi bi-map-fill me-2'></i><strong>View components</strong> on an interactive map to understand regional distribution and scale.</li><li><i class='bi bi-bar-chart-line-fill me-2'></i><strong>Stay informed</strong> with clean, accessible visuals of how the Capacity Market is shaping the energy landscape.</li></ul><p class='mt-2'>It's an open-access tool designed to bring transparency to one of the UK's most important energy mechanisms. We charge a small fee to cover running costs.</p>">
            üîç How to Use This Site
        </a>
    </div>
</div>


    <!-- Theme Cycle Button (Remains Fixed Top Right) -->
    <div class="theme-button-container" style="position: fixed; top: 10px; right: 15px; z-index: 1050;">
        <button class="btn btn-secondary btn-sm" type="button" id="themeCycleButton" title="Change theme">
            <i class="bi" id="theme-icon"></i> <span id="theme-text">Theme</span>
        </button>
    </div>

    <!-- Floating Help Button -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1050;">
        <button class="btn btn-primary rounded-circle" type="button" id="helpButton" data-bs-toggle="modal" data-bs-target="#helpModal" title="Help & Guide">
            <i class="bi bi-question-lg"></i>
        </button>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">Capacity Market Search Guide</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="list-group" id="helpTabList">
                                    <a class="list-group-item list-group-item-action active" href="#help-general">Search Guide</a>
                                    <a class="list-group-item list-group-item-action" href="#help-auctions">Understanding Auctions</a>
                                    <a class="list-group-item list-group-item-action" href="#help-results">Search Results</a>
                                    <a class="list-group-item list-group-item-action" href="#help-grouping">Component Grouping</a>
                                    <a class="list-group-item list-group-item-action" href="#help-filters">Sorting</a>
                                    <a class="list-group-item list-group-item-action" href="#help-map">Map View</a>
                                    <a class="list-group-item list-group-item-action" href="#help-stats">Statistics</a>
                                    <a class="list-group-item list-group-item-action" href="#help-contact">Contact Us</a>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div id="helpContent" style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                                    <div class="help-section" id="help-general">
                                        <h4>Search Guide</h4>
                                        <p>This registry provides comprehensive search capabilities across all Capacity Market components:</p>
                                        <ul>
                                            <li><strong>Company Search:</strong> Enter a company name (e.g., "Drax", "EDF") to see all their components</li>
                                            <li><strong>Location Search:</strong> Search by city, region, or postcode (e.g., "Manchester", "SW1")</li>
                                            <li><strong>CMU ID Search:</strong> Enter a specific CMU ID to find exact components</li>
                                            <li><strong>Technology Search:</strong> Enter technology types like "Hydro", "OCGT", or "Battery"</li>
                                        </ul>
                                        <p>The search is intelligent and will try to determine what you're looking for based on your query.</p>
                                        <p>You can combine search terms to narrow results, such as "London Battery" to find battery storage in London.</p>
                                        <p>Searches are not case-sensitive, and partial matches are supported (e.g., "Manch" will find "Manchester").</p>
                                    </div>
                                    
                                    <div class="help-section" id="help-auctions">
                                        <h4>Understanding Auctions</h4>
                                        <p>The Capacity Market runs regular auctions where providers compete to secure agreements. There are two main types:</p>
                                        <ul>
                                            <li><strong>T-4 auctions:</strong> Held 4 years ahead of the delivery year</li>
                                            <li><strong>T-1 auctions:</strong> Held 1 year ahead to fine-tune capacity requirements</li>
                                        </ul>
                                        <p>Each auction results in agreements that specify how much capacity providers must deliver and the payment they'll receive.</p>
                                        <p>Auction years are displayed as badges (e.g., <span class="badge bg-warning text-dark">2023-24</span>) that you can click to view details for that specific auction year.</p>
                                        <p>The Capacity Market ensures the UK has sufficient electricity supply during periods of high demand or system stress.</p>
                                        <p>Providers receive payments for ensuring their capacity is available, creating a more stable and resilient electricity market.</p>
                                    </div>
                                    
                                    <div class="help-section" id="help-results">
                                        <h4>Search Results</h4>
                                        <p>Search results are grouped by location and show important details about each component:</p>
                                        <ul>
                                            <li><span class="badge bg-success">Active</span> Components with auction years 2024-25 or later</li>
                                            <li><span class="badge bg-secondary">In-Active</span> Components with only auction years before 2024-25</li>
                                            <li><span class="badge bg-success">Company Name</span> Click to view all components for this company</li>
                                            <li><span class="badge bg-primary">Technology</span> Click to search for this technology type</li>
                                            <li><span class="badge bg-secondary">CMU: XXX</span> Click to search for this CMU ID</li>
                                            <li><span class="badge bg-warning text-dark">Auction Year</span> Click to view details for this specific auction</li>
                                        </ul>
                                        <p>Each result shows the component's capacity, location details, and participation in specific auction years.</p>
                                        <p>You can sort results by relevance, location, or date using the sort options.</p>
                                        <p>Pagination controls appear at the bottom when there are multiple pages of results.</p>
                                    </div>
                                    
                                    <div class="help-section" id="help-grouping">
                                        <h4>Component Grouping</h4>
                                        <p>Components at the same location with the same description are grouped together to reduce duplication.</p>
                                        <p>Each group shows:</p>
                                        <ul>
                                            <li>All CMU IDs for components at that location</li>
                                            <li>All auction years, sorted with newest first</li>
                                            <li>An Active/Inactive status based on auction years</li>
                                        </ul>
                                        <p>Grouping helps identify multi-year contracts and related components at the same site.</p>
                                        <p>The total capacity shown combines all components in the group.</p>
                                        <p>Components can be expanded to show individual details by clicking the expand icon.</p>
                                    </div>
                                    
                                    <div class="help-section" id="help-filters">
                                        <h4>Sorting and Filtering</h4>
                                        <p>You can sort search results by:</p>
                                        <ul>
                                            <li><strong>Relevance:</strong> Most relevant matches first</li>
                                            <li><strong>Location:</strong> Alphabetical order by location name</li>
                                            <li><strong>Date:</strong> By auction year (newest or oldest first)</li>
                                            <li><strong>Capacity:</strong> Highest or lowest capacity first</li>
                                        </ul>
                                        <p>Click the column headers to change sort order.</p>
                                        <p>You can filter results using the search refinements at the top of the results page:</p>
                                        <ul>
                                            <li>Filter by technology type (e.g., only show batteries)</li>
                                            <li>Filter by active status (show only active or inactive components)</li>
                                            <li>Filter by auction year (show only components from specific auctions)</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="help-section" id="help-map">
                                        <h4>Map View</h4>
                                        <p>The <a href="/map_results/technology/">Map View</a> shows components geographically with filtering options for:</p>
                                        <ul>
                                            <li>Technology type</li>
                                            <li>Active/Inactive status</li>
                                            <li>Company</li>
                                        </ul>
                                        <p>The map provides a visual representation of capacity distribution across the UK.</p>
                                        
                                        <h5>Map Features:</h5>
                                        <ul>
                                            <li><strong>Technology Colors:</strong> Different technology types are shown with distinct colors on the map for easy identification:
                                                <div class="mt-2 mb-2">
                                                    <div class="row g-2">
                                                        <div class="col-md-6">
                                                            <span class="badge me-1" style="background-color: #ff5252; color: white;">Gas</span>
                                                            <span class="badge me-1" style="background-color: #f57c00; color: white;">DSR</span>
                                                            <span class="badge me-1" style="background-color: #8d6e63; color: white;">Nuclear</span>
                                                            <span class="badge me-1" style="background-color: #5c6bc0; color: white;">CHP</span>
                                                            <span class="badge me-1" style="background-color: #fdd835; color: black;">Solar</span>
                                                            <span class="badge me-1" style="background-color: #29b6f6; color: white;">Wind</span>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <span class="badge me-1" style="background-color: #4caf50; color: white;">Battery</span>
                                                            <span class="badge me-1" style="background-color: #8bc34a; color: white;">Biomass</span>
                                                            <span class="badge me-1" style="background-color: #0097a7; color: white;">Hydro</span>
                                                            <span class="badge me-1" style="background-color: #9c27b0; color: white;">Interconnector</span>
                                                            <span class="badge me-1" style="background-color: #424242; color: white;">Coal</span>
                                                            <span class="badge me-1" style="background-color: #757575; color: white;">Other</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </li>
                                            <li><strong>Technology Legend:</strong> The map legend shows all available technologies with their corresponding colors and component counts</li>
                                            <li><strong>Search Results on Map:</strong> You can view any search results on the map by clicking "View on Map" from search results pages</li>
                                            <li><strong>Smart Clustering:</strong> Areas with multiple components are automatically grouped into clusters - click clusters to zoom in and see individual components</li>
                                            <li><strong>Interactive Markers:</strong> Click on individual markers to see detailed information about components at that location</li>
                                        </ul>
                                        
                                        <p>Use the map controls to zoom in on specific regions or areas of interest. The map automatically adjusts clustering based on your zoom level to provide the clearest view of capacity distribution.</p>
                                    </div>
                                    
                                    <div class="help-section" id="help-stats">
                                        <h4>Statistics</h4>
                                        <p>The <a href="/statistics/">Statistics page</a> provides visual breakdowns of the Capacity Market by:</p>
                                        <ul>
                                            <li>Company</li>
                                            <li>Technology</li>
                                            <li>Geographic distribution</li>
                                        </ul>
                                        <p>Charts and graphs show trends across auction years and technology adoption.</p>
                                        <p>The statistics page helps identify market leaders and track changes in capacity mix over time.</p>
                                        <p>Interactive visualizations let you drill down into specific aspects of the market.</p>
                                        <p>Data can be filtered by auction year to track market evolution.</p>
                                    </div>
                                    
                                    <div class="help-section" id="help-contact">
                                        <h4>Contact Us</h4>
                                        <p>We're here to help with any questions about the Capacity Market Registry.</p>
                                        
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <h5 class="card-title"><i class="bi bi-envelope-fill me-2"></i>Email</h5>
                                                <p class="card-text">For general inquiries and support:</p>
                                                <p><a href="mailto:hello@capacitymarket.co.uk" class="btn btn-primary">hello@capacitymarket.co.uk</a></p>
                                            </div>
                                        </div>
                                        


                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    
    <div class="
container container-no-results
">
        
    
    
        
            <!-- No Results Message -->
            <div class="text-center w-100">
                <div class="alert alert-danger alert-no-results mt-4">
                    No matching companies or components found for "test123".
                </div>
            </div>
        
    

    
    <div class="mt-2 mb-3">
        <p class="text-center small text-muted">
            
            <a data-bs-toggle="collapse" href="#perfMetrics" role="button" aria-expanded="false" aria-controls="perfMetrics" class="text-info">
                Query time: 2.31s (click to see details)
            </a>
            
            
            
        </p>
        
        <!-- Performance Metrics Collapse Panel -->
        
        <div class="collapse mb-3" id="perfMetrics">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-center">Performance Timing Details</h5>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Operation</th>
                                <th>Time (s)</th>
                                <th>% of Total</th>
                            </tr>
                        </thead>
                        <tbody>
                        
                            <tr>
                                <td>initial_setup_live_fetch</td>
                                <td>0.0025</td>
                                <td>0%</td>
                            </tr>
                        
                            <tr>
                                <td>cmu_df_load</td>
                                <td>0.0454</td>
                                <td>2%</td>
                            </tr>
                        
                            <tr>
                                <td>company_fuzzy_search</td>
                                <td>0.0114</td>
                                <td>0%</td>
                            </tr>
                        
                            <tr>
                                <td>company_link_building</td>
                                <td>0.1801</td>
                                <td>8%</td>
                            </tr>
                        
                            <tr>
                                <td>total_company_search</td>
                                <td>0.2370</td>
                                <td>10%</td>
                            </tr>
                        
                            <tr>
                                <td>cmu_id_check</td>
                                <td>0.0410</td>
                                <td>2%</td>
                            </tr>
                        
                            <tr>
                                <td>company_check</td>
                                <td>0.0000</td>
                                <td>0%</td>
                            </tr>
                        
                            <tr>
                                <td>location_check</td>
                                <td>0.1225</td>
                                <td>5%</td>
                            </tr>
                        
                            <tr>
                                <td>search_type_determination</td>
                                <td>0.1635</td>
                                <td>7%</td>
                            </tr>
                        
                            <tr>
                                <td>component_filter_construction</td>
                                <td>0.0001</td>
                                <td>0%</td>
                            </tr>
                        
                            <tr>
                                <td>database_query_execution</td>
                                <td>0.7549</td>
                                <td>33%</td>
                            </tr>
                        
                            <tr>
                                <td>format_components</td>
                                <td>0.0440</td>
                                <td>2%</td>
                            </tr>
                        
                            <tr>
                                <td>pagination_setup</td>
                                <td>0.0000</td>
                                <td>0%</td>
                            </tr>
                        
                            <tr class="table-primary">
                                <td>total_search_time</td>
                                <td>2.3083</td>
                                <td>100%</td>
                            </tr>
                        
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>
    

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script src="https://unpkg.com/htmx.org@2.0.0/dist/htmx.min.js" integrity="sha384-wS5l5IKJBvK6sPTKa2WZ1js3d947pvWXbPJ1OmWfEuxLgeHcEbjUUA5i9V5ZkpCw" crossorigin="anonymous"></script>
    
    <!-- Help Modal JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the tab links and content container
            const tabLinks = document.querySelectorAll('#helpTabList .list-group-item');
            const contentContainer = document.getElementById('helpContent');
            
            if (tabLinks.length && contentContainer) {
                // Add click handlers to each tab link
                tabLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // Remove active class from all tabs
                        tabLinks.forEach(tab => tab.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        this.classList.add('active');
                        
                        // Get target section
                        const targetId = this.getAttribute('href');
                        const targetSection = document.querySelector(targetId);
                        
                        if (targetSection) {
                            // Scroll to the target section with smooth behavior
                            contentContainer.scrollTo({
                                top: targetSection.offsetTop - 20, // 20px offset for better spacing
                                behavior: 'smooth'
                            });
                            
                            // Highlight section briefly
                            targetSection.classList.add('highlight-section');
                            setTimeout(() => {
                                targetSection.classList.remove('highlight-section');
                            }, 1000);
                        }
                    });
                });
            }
            
            // Help modal initialization
            const helpModal = document.getElementById('helpModal');
            if (helpModal) {
                helpModal.addEventListener('show.bs.modal', function() {
                    // Click the first tab when the modal opens
                    const firstTab = document.querySelector('#helpTabList .list-group-item');
                    if (firstTab) {
                        firstTab.click();
                    }
                    
                    // Reset scroll position
                    if (contentContainer) {
                        contentContainer.scrollTop = 0;
                    }
                });
            }
        });
    </script>
    
    
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Show more companies button behavior
            const showMoreBtn = document.getElementById('show-more-companies-btn');
            const companyList = document.getElementById('company-links-list');

            if (showMoreBtn && companyList) {
                showMoreBtn.addEventListener('click', function() {
                    const hiddenItems = companyList.querySelectorAll('.company-link-item[style*="display: none"]');
                    hiddenItems.forEach(item => { item.style.display = ''; });
                    showMoreBtn.style.display = 'none';
                });
            }
            
            // Load More Results functionality has been removed in favor of pagination
            // We're now using traditional pagination with page links instead
            
            // Add loading indicator for form search and links
            const searchForm = document.querySelector('.search-form'); 
            const resultsContainer = document.querySelector('.content-below-header');
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay position-fixed d-none';
            loadingOverlay.style.cssText = 'top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; display:flex; align-items:center; justify-content:center;';
            loadingOverlay.innerHTML = `
                <div class="card p-4">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-3" role="status"></div>
                        <div class="h5 mb-0">Loading results...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingOverlay);
            
            // Show loading overlay for search form, sort, and pagination links
             if (searchForm) {
                 searchForm.addEventListener('submit', function() {
                    loadingOverlay.classList.remove('d-none');
                });
            }
            
            // Handle clicks on sort controls and pagination links
            const navigationLinks = document.querySelectorAll('.sort-controls a, .pagination a');
            navigationLinks.forEach(link => {
                 link.addEventListener('click', function() {
                    loadingOverlay.classList.remove('d-none');
                 });
             });

            // Initialize Bootstrap Popovers
            const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
            const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, {
                sanitize: false // Allow HTML in content
            }));

            // Initialize Bootstrap Tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        });
    </script>


    <!-- Simple Support Popup (doesn't require Bootstrap JS) -->
    <div id="simplePopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-width: 90%; width: 400px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Support This Project</h3>
        <button id="closePopup" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
      </div>
      <p>The easiest way to explore Capacity Market auctions ‚Äî no fuss, just results. If you find this tool valuable, please consider supporting its development.</p>
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <a href="/donate/" style="background: #0d6efd; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold;">
          Support via Stripe
        </a>
      </div>
      <div style="text-align: center; margin-top: 15px;">
        <button id="maybeLater" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
          Maybe Later
        </button>
      </div>
    </div>

    <!-- Overlay background -->
    <div id="popupOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>

    <script>
    // Simple alert to test basic JS execution - REMOVED
    // alert('BASE.HTML SCRIPT BLOCK REACHED!'); 
    // console.log('BASE.HTML SCRIPT BLOCK REACHED!');

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, setting up simple popup timer');

        // Get popup elements
        const popup = document.getElementById('simplePopup');
        const overlay = document.getElementById('popupOverlay');
        const closeBtn = document.getElementById('closePopup');
        const laterBtn = document.getElementById('maybeLater');

        if (!popup || !overlay || !closeBtn || !laterBtn) {
            console.error('One or more popup elements not found');
            return;
        }

        // Check if shown recently
        const lastShown = localStorage.getItem('popupLastShown');
        if (lastShown && (Date.now() - parseInt(lastShown) < 24 * 60 * 60 * 1000)) {
            console.log('Popup was shown recently, skipping');
            return;
        }

        // Function to show popup
        function showPopup() {
            console.log('Showing popup');
            popup.style.display = 'block';
            overlay.style.display = 'block';
            localStorage.setItem('popupLastShown', Date.now().toString());
        }

        // Function to hide popup
        function hidePopup() {
            console.log('Hiding popup');
            popup.style.display = 'none';
            overlay.style.display = 'none';
        }

        // Set up event listeners
        closeBtn.addEventListener('click', hidePopup);
        laterBtn.addEventListener('click', hidePopup);
        overlay.addEventListener('click', hidePopup);

        // Show popup after 10 seconds
        console.log('Setting timeout to show popup in 10 seconds');
        setTimeout(showPopup, 10000);
    });

    // Theme Switching Logic (Updated for Cycling Button)
    document.addEventListener('DOMContentLoaded', function() {
        const themeCycleButton = document.getElementById('themeCycleButton');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text'); // Optional: if you want to show text
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const themes = ['auto', 'light', 'dark'];

        // Function to get the actual theme (light/dark) based on preference
        const getEffectiveTheme = (preference) => {
            if (preference === 'auto') {
                return prefersDarkScheme.matches ? 'dark' : 'light';
            }
            return preference;
        };

        // Function to update the button appearance based on *preference*
        const updateButtonAppearance = (preference) => {
            let iconClass = '';
            let buttonText = ''; // Text representation of the preference
            switch (preference) {
                case 'light':
                    iconClass = 'bi-sun-fill';
                    buttonText = 'Light';
                    break;
                case 'dark':
                    iconClass = 'bi-moon-stars-fill';
                    buttonText = 'Dark';
                    break;
                default: // auto
                    iconClass = 'bi-circle-half';
                    buttonText = 'Auto';
                    break;
            }
            themeIcon.className = `bi ${iconClass}`;
            themeText.textContent = buttonText; // Update text to show preference
            themeCycleButton.setAttribute('title', `Theme: ${buttonText}`);
        };

        // Function to apply the theme to the document
        const applyTheme = (theme) => {
            document.documentElement.setAttribute('data-bs-theme', theme);
        };

        // Get initial preference or default to 'auto'
        let currentPreference = localStorage.getItem('theme_preference') || 'auto';

        // Set initial state
        updateButtonAppearance(currentPreference);
        applyTheme(getEffectiveTheme(currentPreference));

        // Add listener for system theme changes (only affects display if preference is 'auto')
        prefersDarkScheme.addEventListener('change', () => {
            if (localStorage.getItem('theme_preference') === 'auto') {
                applyTheme(getEffectiveTheme('auto'));
                // No need to update button appearance, as preference remains 'auto'
            }
        });

        // Add listener for button click to cycle through themes
        themeCycleButton.addEventListener('click', () => {
            // Find current index
            let currentIndex = themes.indexOf(currentPreference);
            // Calculate next index (cycling)
            let nextIndex = (currentIndex + 1) % themes.length;
            // Get the next preference
            currentPreference = themes[nextIndex];

            // Store the new preference
            localStorage.setItem('theme_preference', currentPreference);

            // Update button and apply the effective theme
            updateButtonAppearance(currentPreference);
            applyTheme(getEffectiveTheme(currentPreference));
        });
    });
    </script>

    
    
    <script>
    // Add event listener for page changes via history API
    window.addEventListener('popstate', function(event) {
        console.log('Timer Debug: Navigation event detected (popstate)');
        console.log('Timer Debug: Current timer stage =', sessionStorage.getItem('redirectTimerStage'));
        console.log('Timer Debug: Current timer start =', sessionStorage.getItem('redirectTimerStart'));
    });
    
    // Global absolute timeout to ensure redirect happens eventually
    // This runs once per session as a fallback in case stage timers don't complete
    document.addEventListener('DOMContentLoaded', function() {
        const absoluteTimeoutKey = 'absoluteTimeoutSet';
        const pageCountKey = 'pageVisitCount';
        const redirectUrl = "/account/must-register/";
        
        // Define auth paths that should be excluded from redirect and counting
        const authPaths = [
            '/accounts/login/',
            '/accounts/register/', 
            '/accounts/must-register/', 
            '/accounts/password_reset/', 
            '/accounts/activate/', 
            '/accounts/registration-pending/',
            '/accounts/activation-failed/',
            '/accounts/reset/',
            '/login/', // Standard Django login URL
            '/register/', // In case there's a base register URL
            '/accounts/', // General accounts path prefix
            '/account/' // Alternative accounts path prefix
        ];
        
        // Check if current page is an auth page
        const currentPath = window.location.pathname;
        const isAuthPage = authPaths.some(path => currentPath.startsWith(path));
        
        // If we're on an auth page, don't increment counter or redirect
        if (isAuthPage) {
            console.log('On authentication page, skipping page counter and timeout');
            return;
        }
        
        // Track page visit count (only for non-auth pages)
        let pageCount = parseInt(sessionStorage.getItem(pageCountKey) || '0');
        pageCount++;
        sessionStorage.setItem(pageCountKey, pageCount.toString());
        console.log(`Page visit count: ${pageCount}`);
        
        // If user is rapidly changing pages (more than 20 visits), force redirection
        if (pageCount > 20) {
            console.log('Too many page changes detected, redirecting now');
            window.location.href = redirectUrl;
            return;
        }
        
        if (!sessionStorage.getItem(absoluteTimeoutKey)) {
            // Set a maximum total time allowed for browsing (30 minutes = 1800s)
            const totalMaxTime = 1800 * 1000;
            console.log(`Setting absolute timeout for ${totalMaxTime/1000}s`);
            
            setTimeout(() => {
                // Check again that we're not on an auth page before redirecting
                const currentPathCheck = window.location.pathname;
                const isAuthPageCheck = authPaths.some(path => currentPathCheck.startsWith(path));
                
                if (!isAuthPageCheck) {
                    console.log('Absolute timeout reached, redirecting now.');
                    window.location.href = redirectUrl;
                } else {
                    console.log('Absolute timeout reached, but on auth page - not redirecting.');
                }
            }, totalMaxTime);
            
            sessionStorage.setItem(absoluteTimeoutKey, 'true');
        }
    });
    
    // Main redirect timer
    document.addEventListener('DOMContentLoaded', function() {
        // Define paths where the timer should NOT run
        const authPaths = [
            '/accounts/login/',
            '/accounts/register/', 
            '/accounts/must-register/', // Don't run on the target page itself
            '/accounts/password_reset/', 
            '/accounts/activate/', 
            '/accounts/registration-pending/',
            '/accounts/activation-failed/',
            '/accounts/reset/',
            '/login/', // Standard Django login URL
            '/register/', // In case there's a base register URL
            '/accounts/', // General accounts path prefix
            '/account/' // Alternative accounts path prefix
        ];
        const currentPath = window.location.pathname;

        // Check if current path starts with any excluded path
        const isAuthPage = authPaths.some(path => currentPath.startsWith(path));
        if (isAuthPage) {
            console.log('Redirect timer disabled on excluded page:', currentPath);
            return; // Do not start the timer
        }

        // Check if this is the map page - special handling
        const isMapPage = currentPath.startsWith('/map') || currentPath.includes('/map/');
        
        const redirectUrl = "/account/must-register/";
        const stageKey = 'redirectTimerStage'; // Current stage (120, 60, or 30)
        const startTimeKey = 'redirectTimerStart'; // When the current stage timer started
        const lastPageKey = 'redirectTimerLastPage'; // Last page visited
        let currentStage = sessionStorage.getItem(stageKey);
        let stageStartTime = sessionStorage.getItem(startTimeKey);
        let timeoutDurationMs;
        
        // Record the current page
        const lastPageVisited = sessionStorage.getItem(lastPageKey);
        sessionStorage.setItem(lastPageKey, currentPath);

        // Add debug info about the current page
        console.log(`Timer Debug: Current page path = ${currentPath}`);
        console.log(`Timer Debug: Is excluded page = ${isAuthPage}`);
        console.log(`Timer Debug: Is map page = ${isMapPage}`);
        console.log(`Timer Debug: Last page visited = ${lastPageVisited || 'none'}`);
        console.log(`Timer Debug: Current stage = ${currentStage || 'not set'}`);
        console.log(`Timer Debug: Stage start time = ${stageStartTime || 'not set'}`);
        
        // Initialize stage if not set (first visit in this session)
        if (!currentStage) {
            // For map page, start directly at 5 minutes (300 seconds)
            if (isMapPage) {
                currentStage = 'map-300';
                console.log('Redirect Timer: Map page detected, initializing to 300s (5 min) direct timer.');
            } else {
                currentStage = '600'; // Start at 600 seconds (10 minutes) for regular pages
                console.log('Redirect Timer: Initializing stage to 120s.');
            }
            stageStartTime = Date.now().toString();
            sessionStorage.setItem(stageKey, currentStage);
            sessionStorage.setItem(startTimeKey, stageStartTime);
        } else if (isMapPage && currentStage !== 'map-300' && lastPageVisited !== currentPath) {
            // If navigating to map page from another page, use the 5-minute timer
            console.log('Redirect Timer: Switching to map page 300s (5 min) timer.');
            currentStage = 'map-300';
            stageStartTime = Date.now().toString();
            sessionStorage.setItem(stageKey, currentStage);
            sessionStorage.setItem(startTimeKey, stageStartTime);
        }

        // If we have a stage but no start time, set it now
        if (!stageStartTime) {
            stageStartTime = Date.now().toString();
            sessionStorage.setItem(startTimeKey, stageStartTime);
            console.log('Redirect Timer: Setting missing start time for current stage.');
        }

        // Determine timeout duration based on the current stage
        if (currentStage === 'map-300') {
            timeoutDurationMs = 300 * 1000; // Special 5-minute timer for map page
        } else if (currentStage === '600') {
            timeoutDurationMs = 600 * 1000; // 10 minutes
        } else if (currentStage === '300') {
            timeoutDurationMs = 300 * 1000; // 5 minutes
        } else { // Stage is '300-final' or potentially invalid, default to 5 minutes
            timeoutDurationMs = 300 * 1000; // 5 minutes
            // Ensure stage is correctly set to 300-final if it wasn't already
            if (currentStage !== '300-final') { 
                sessionStorage.setItem(stageKey, '300-final');
                console.log('Redirect Timer: Correcting stage to 300s (5 min) final.');
            }
            currentStage = '300-final'; // Ensure variable reflects 300-final for logging
        }

        // Calculate remaining time in current stage
        const now = Date.now();
        const elapsedMs = now - parseInt(stageStartTime);
        const remainingMs = timeoutDurationMs - elapsedMs;
        
        console.log(`Redirect Timer: ${Math.round(remainingMs / 1000)}s remaining in current ${currentStage}s stage.`);

        // If time already elapsed, move to next stage immediately
        if (remainingMs <= 0) {
            console.log('Redirect Timer: Stage time elapsed, processing immediately.');
            handleStageCompletion();
        } else {
            // Set timeout for remaining time in this stage
            console.log(`Redirect Timer: Setting timeout for remaining ${Math.round(remainingMs / 1000)}s.`);
            
            // Store a unique timer ID to prevent duplicate timers
            const timerIdKey = 'redirectTimerId';
            const timerId = Date.now().toString();
            sessionStorage.setItem(timerIdKey, timerId);
            
            setTimeout(() => {
                // Check if we're now on an auth page before executing
                const currentPathCheck = window.location.pathname;
                const isAuthPageNow = authPaths.some(path => currentPathCheck.startsWith(path));
                
                // Only process if we're NOT on an auth page and this is still the active timer
                if (!isAuthPageNow && sessionStorage.getItem(timerIdKey) === timerId) {
                    handleStageCompletion();
                } else if (isAuthPageNow) {
                    console.log('Redirect Timer: We are now on an auth page, skipping redirect');
                } else {
                    console.log('Redirect Timer: Ignoring outdated timer callback');
                }
            }, remainingMs);
        }

        // Function to handle the completion of a stage
        function handleStageCompletion() {
            console.log('Redirect Timer: Stage completed.');
            
            // Re-check current stage to ensure it hasn't been changed by another part of the code
            const currentStageCheck = sessionStorage.getItem(stageKey);
            if (currentStageCheck !== currentStage) {
                console.log(`Redirect Timer: Stage changed externally from ${currentStage} to ${currentStageCheck}, aborting handler`);
                return;
            }
            
            // Double-check we're not on an auth page
            const currentPathCheck = window.location.pathname;
            const isAuthPageNow = authPaths.some(path => currentPathCheck.startsWith(path));
            if (isAuthPageNow) {
                console.log('Redirect Timer: Cannot proceed with redirect, user is now on an auth page');
                return;
            }
            
            // Determine the next stage
            let nextStage;
            if (currentStage === 'map-300') {
                // Map page goes straight to redirect
                console.log('Redirect Timer: Map page 5 min timer complete, redirecting.');
                window.location.href = redirectUrl;
                return;
            } else if (currentStage === '600') {
                nextStage = '300';
            } else if (currentStage === '300') {
                nextStage = '300-final';
            } else { // Already at 300-final, redirect
                console.log('Redirect Timer: Final stage complete, redirecting.');
                window.location.href = redirectUrl;
                return;
            }

            // Update stage and reset timer
            console.log(`Redirect Timer: Moving to next stage: ${nextStage}s`);
            sessionStorage.setItem(stageKey, nextStage);
            sessionStorage.setItem(startTimeKey, Date.now().toString());
            
            // Store a unique timer ID to prevent duplicate timers
            const timerIdKey = 'redirectTimerId';
            const timerId = Date.now().toString();
            sessionStorage.setItem(timerIdKey, timerId);
            
            // Set timeout for the next stage
            const nextStageDurationMs = nextStage === '300' ? 300000 : 300000; // Both stages are 5 minutes
            setTimeout(() => {
                // Check again for auth pages
                const currentPathCheck = window.location.pathname;
                const isAuthPageNow = authPaths.some(path => currentPathCheck.startsWith(path));
                
                // Only process if we're NOT on an auth page and this is still the active timer
                if (!isAuthPageNow && sessionStorage.getItem(timerIdKey) === timerId) {
                    handleStageCompletion();
                } else if (isAuthPageNow) {
                    console.log('Redirect Timer: We are now on an auth page, skipping stage completion');
                } else {
                    console.log('Redirect Timer: Ignoring outdated timer callback');
                }
            }, nextStageDurationMs);
        }
    });
    </script>
    
    

    
    
    

    
    
    <!-- Mobile hamburger menu functionality -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Only add hamburger menu functionality on non-map pages
        const isMapPage = window.location.pathname.includes('/map');
        
        if (!isMapPage) {
            const hamburgerBtn = document.getElementById('mobileHamburgerBtn');
            const overlay = document.getElementById('mobileNavOverlay');
            const panel = document.getElementById('mobileNavPanel');
            
            if (hamburgerBtn && overlay && panel) {
                function toggleMobileMenu() {
                    hamburgerBtn.classList.toggle('active');
                    overlay.classList.toggle('active');
                    panel.classList.toggle('active');
                }
                
                hamburgerBtn.addEventListener('click', toggleMobileMenu);
                overlay.addEventListener('click', toggleMobileMenu);
                
                // Close menu when clicking nav items
                const navItems = panel.querySelectorAll('.mobile-nav-item');
                navItems.forEach(item => {
                    if (item.tagName === 'A') {
                        item.addEventListener('click', function() {
                            // Small delay to allow navigation to start
                            setTimeout(toggleMobileMenu, 100);
                        });
                    }
                });
            }
        } else {
            // Hide hamburger menu on map pages
            const hamburgerBtn = document.getElementById('mobileHamburgerBtn');
            if (hamburgerBtn) {
                hamburgerBtn.style.display = 'none';
            }
        }
    });
    </script>
</body>
</html>